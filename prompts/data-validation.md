# 데이터 유효성 검증 규칙 (Data Validation Rules)

> 이 문서는 업로드되는 Ecount CSV 파일의 데이터 무결성을 보장하기 위한 유효성 검증 규칙을 정의합니다.
>
> **기준 문서:** `docs/csv-sample.md`에 명세된 실제 CSV 파일 구조를 기반으로 작성됩니다.

---

## 1. 검증 수준 (Validation Levels)

### 1.1 파일 레벨 검증 (File-Level Validation)
업로드된 파일 자체의 유효성을 검증합니다. 실패 시 전체 업로드가 거부됩니다.

| 검증 항목 | 검증 규칙 | 실패 시 처리 |
|----------|----------|-------------|
| 파일 형식 | `.csv` (Comma-Separated Values) | 전체 업로드 거부, 오류 메시지 반환 |
| 파일 크기 | 최대 100MB | 전체 업로드 거부, 오류 메시지 반환 |
| 파일 인코딩 | UTF-8 with BOM (한글 지원) | 전체 업로드 거부, 오류 메시지 반환 |
| 필수 파일 존재 | `docs/csv-sample.md`의 필수 CSV 파일 모두 존재 | 전체 업로드 거부, 누락된 파일명 표시 |

---

### 1.2 파일 헤더 레벨 검증 (Header-Level Validation)
각 CSV 파일의 헤더 구조를 검증합니다. 실패 시 해당 파일 전체가 무시됩니다.

| 검증 항목 | 검증 규칙 | 실패 시 처리 |
|----------|----------|-------------|
| 헤더 존재 | 1행에 헤더가 존재 | 해당 파일 무시, 경고 로그 |
| 헤더 일치 | `docs/csv-sample.md`의 컬럼명과 일치 | 해당 파일 무시, 경고 로그 |
| 필수 컬럼 존재 | 필수로 표시된 모든 컬럼이 존재 | 해당 파일 무시, 누락된 컬럼명 표시 |

---

### 1.3 행 레벨 검증 (Row-Level Validation)
각 데이터 행의 유효성을 검증합니다. 실패 시 해당 행만 무시하고 처리를 계속합니다.

---

## 2. 파일별 검증 규칙

### 2.1 파일: department_kpi.csv (학과 KPI)

#### 컬럼별 검증 규칙

| 컬럼명 | 컬럼 인덱스 | 검증 규칙 | 위반 시 처리 |
|--------|------------|----------|-------------|
| 날짜 | A (1) | • 데이터 타입: Date (YYYY-MM-DD 형식)<br>• 필수: Yes<br>• 형식: YYYY-MM-DD, YYYY.MM.DD, YYYY/MM/DD 허용<br>• 매월 1일 기준 (DD는 01이어야 함)<br>• 과거 날짜만 허용 (미래 날짜 불가) | 해당 행 무시, 로그 기록 |
| 실적 | B (2) | • 데이터 타입: Integer<br>• 필수: Yes<br>• 범위: 0 이상<br>• 음수 불가 | 해당 행 무시, 로그 기록 |
| 논문수 | C (3) | • 데이터 타입: Integer<br>• 필수: Yes<br>• 범위: 0 이상<br>• 음수 불가 | 해당 행 무시, 로그 기록 |
| 학생수 | D (4) | • 데이터 타입: Integer<br>• 필수: Yes<br>• 범위: 1 이상 (학생이 0명일 수 없음)<br>• 음수 불가 | 해당 행 무시, 로그 기록 |
| 예산 | E (5) | • 데이터 타입: Decimal(15,2)<br>• 필수: Yes<br>• 범위: 0 이상<br>• 음수 불가 | 해당 행 무시, 로그 기록 |
| 비고 | F (6) | • 데이터 타입: String<br>• 필수: No<br>• 최대 길이: 500자<br>• 빈 값 허용 | 길이 초과 시 자동 절단, 경고 로그 |

#### 크로스 필드 검증 (Cross-Field Validation)

| 검증 규칙 | 설명 | 위반 시 처리 |
|----------|------|-------------|
| 날짜 중복 체크 | 동일 날짜(년월)의 데이터가 중복되면 안 됨 | 나중에 입력된 행을 무시, 경고 로그 |
| 날짜 순차성 | 날짜가 시간 순서대로 정렬되어 있어야 함 (권장) | 경고만 표시, 처리는 계속 |

---

### 2.2 파일: publication_list.csv (논문 목록)

#### 컬럼별 검증 규칙

| 컬럼명 | 컬럼 인덱스 | 검증 규칙 | 위반 시 처리 |
|--------|------------|----------|-------------|
| 게재일 | A (1) | • 데이터 타입: Date (YYYY-MM-DD 형식)<br>• 필수: Yes<br>• 과거 날짜만 허용 | 해당 행 무시, 로그 기록 |
| 논문제목 | B (2) | • 데이터 타입: String<br>• 필수: Yes<br>• 최대 길이: 500자<br>• 빈 문자열 불가 | 해당 행 무시, 로그 기록 |
| 저자 | C (3) | • 데이터 타입: String<br>• 필수: Yes<br>• 최대 길이: 300자<br>• 형식: 쉼표(,)로 구분된 저자명<br>• 최대 10명까지 | 10명 초과 시 경고, 처리는 계속 |
| 학술지명 | D (4) | • 데이터 타입: String<br>• 필수: Yes<br>• 최대 길이: 200자 | 해당 행 무시, 로그 기록 |
| 분류 | E (5) | • 데이터 타입: Enum<br>• 필수: Yes<br>• 허용 값: 'SCI', 'KCI', '일반'<br>• 대소문자 구분 없음 (자동 변환) | 해당 행 무시, 로그 기록 |

#### 크로스 필드 검증

| 검증 규칙 | 설명 | 위반 시 처리 |
|----------|------|-------------|
| 논문 중복 체크 | 동일 제목의 논문이 중복되면 경고 | 경고 표시, 처리는 계속 |

---

### 2.3 파일: student_roster.csv (학생 명부)

#### 컬럼별 검증 규칙

| 컬럼명 | 컬럼 인덱스 | 검증 규칙 | 위반 시 처리 |
|--------|------------|----------|-------------|
| 기준월 | A (1) | • 데이터 타입: Date (YYYY-MM-01)<br>• 필수: Yes<br>• 매월 1일 기준 | 해당 행 무시, 로그 기록 |
| 학부생 | B (2) | • 데이터 타입: Integer<br>• 필수: Yes<br>• 범위: 0 이상 | 해당 행 무시, 로그 기록 |
| 석사 | C (3) | • 데이터 타입: Integer<br>• 필수: Yes<br>• 범위: 0 이상 | 해당 행 무시, 로그 기록 |
| 박사 | D (4) | • 데이터 타입: Integer<br>• 필수: Yes<br>• 범위: 0 이상 | 해당 행 무시, 로그 기록 |
| 총계 | E (5) | • 데이터 타입: Integer<br>• 필수: Yes<br>• 범위: 0 이상<br>• 반드시 학부생+석사+박사의 합과 일치 | 해당 행 무시, 로그 기록 |

#### 크로스 필드 검증

| 검증 규칙 | 설명 | 위반 시 처리 |
|----------|------|-------------|
| 총계 일치 검증 | 총계 = 학부생 + 석사 + 박사 | 불일치 시 해당 행 무시, 로그 기록 |

---

### 2.4 파일: research_project_data.csv (연구과제 데이터)

#### 컬럼별 검증 규칙

| 컬럼명 | 컬럼 인덱스 | 검증 규칙 | 위반 시 처리 |
|--------|------------|----------|-------------|
| 기준월 | A (1) | • 데이터 타입: Date (YYYY-MM-01)<br>• 필수: Yes<br>• 매월 1일 기준 | 해당 행 무시, 로그 기록 |
| 배정예산 | B (2) | • 데이터 타입: Decimal(15,2)<br>• 필수: Yes<br>• 범위: 0 이상 | 해당 행 무시, 로그 기록 |
| 집행예산 | C (3) | • 데이터 타입: Decimal(15,2)<br>• 필수: Yes<br>• 범위: 0 이상<br>• 배정예산 이하여야 함 | 해당 행 무시, 로그 기록 |
| 집행률 | D (4) | • 데이터 타입: Decimal(5,2)<br>• 필수: No<br>• 범위: 0 ~ 100<br>• 자동 계산 가능 | 값이 없으면 자동 계산 |
| 비고 | E (5) | • 데이터 타입: String<br>• 필수: No<br>• 최대 길이: 500자 | 길이 초과 시 자동 절단 |

#### 크로스 필드 검증

| 검증 규칙 | 설명 | 위반 시 처리 |
|----------|------|-------------|
| 예산 초과 검증 | 집행예산 ≤ 배정예산 | 위반 시 해당 행 무시, 로그 기록 |
| 집행률 일치 검증 | 집행률 = (집행예산 / 배정예산) * 100 | 불일치 시 자동 재계산, 경고 로그 |

---

## 3. 공통 검증 규칙

### 3.1 빈 행 처리
- 모든 컬럼이 빈 값인 행은 자동으로 무시 (데이터 종료로 간주)
- 일부 컬럼만 빈 값인 경우 행 레벨 검증 적용

### 3.2 공백 처리
- 문자열 데이터의 앞뒤 공백은 자동으로 제거 (trim)
- 숫자 데이터의 공백, 쉼표(,)는 자동으로 제거 후 파싱

### 3.3 데이터 타입 변환
- 날짜: `YYYY-MM-DD`, `YYYY.MM.DD`, `YYYY/MM/DD` 형식을 표준 `YYYY-MM-DD`로 변환
- 숫자: 쉼표가 포함된 숫자 형식 허용 (예: "1,000" → 1000)
- Enum: 대소문자 구분 없이 자동 변환 (예: "sci" → "SCI")

### 3.4 SQL Injection 방지
- 모든 문자열 데이터는 SQL Injection을 방지하기 위해 이스케이프 처리
- 특수문자는 허용하되 DB 저장 전 sanitize

---

## 4. 검증 실패 시 사용자 피드백

### 4.1 파일 레벨 실패
```json
{
  "status": "error",
  "level": "file",
  "message": "파일 업로드에 실패했습니다.",
  "errors": [
    {
      "type": "file_format",
      "message": "지원되지 않는 파일 형식입니다. .csv 파일만 업로드 가능합니다."
    }
  ]
}
```

### 4.2 파일 헤더 레벨 실패
```json
{
  "status": "partial_success",
  "level": "file",
  "message": "일부 CSV 파일을 처리할 수 없습니다.",
  "processed_files": ["department_kpi.csv", "publication_list.csv"],
  "failed_files": [
    {
      "file_name": "student_roster.csv",
      "reason": "필수 컬럼 '학년'이 누락되었습니다."
    }
  ]
}
```

### 4.3 행 레벨 실패
```json
{
  "status": "success",
  "level": "row",
  "message": "데이터 업로드가 완료되었습니다.",
  "total_rows": 100,
  "processed_rows": 95,
  "failed_rows": 5,
  "errors": [
    {
      "file": "department_kpi.csv",
      "row": 12,
      "column": "employment_rate",
      "value": "-100",
      "reason": "음수 값은 허용되지 않습니다."
    }
  ]
}
```

---

## 5. 구현 우선순위

### Phase 1 (MVP)
1. 파일 레벨 검증 (파일 형식, 크기, 인코딩)
2. 파일 헤더 레벨 검증 (필수 파일, 헤더 일치)
3. 기본 행 레벨 검증 (필수 컬럼, 데이터 타입)

### Phase 2
1. 크로스 필드 검증 (총계 일치, 예산 초과 등)
2. 상세한 에러 메시지 및 피드백
3. 자동 수정 기능 (공백 제거, 집행률 자동 계산)

### Phase 3
1. 고급 검증 (중복 체크, 순차성 체크)
2. 검증 실패 로그 저장 및 히스토리 관리
3. 검증 규칙 커스터마이징 (관리자 설정)

---

## 6. 참고 사항

- 이 문서는 `docs/csv-sample.md`에 정의된 실제 CSV 구조를 기반으로 작성되어야 합니다.
- 검증 규칙은 비즈니스 요구사항 변경에 따라 업데이트될 수 있습니다.
- 구현 시 Zod 또는 유사한 스키마 검증 라이브러리 사용을 권장합니다.
